 
{% extends 'admin/master.html' %}
{% block body %}
<script src="{{ url_for('static', filename='lib/jquery/jquery-3.3.1.js') }}"></script>
<script src="{{ url_for('static', filename='lib/mediaelement/build/mediaelement-and-player.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='lib/mediaelement/build/mediaelementplayer.min.css') }}" />

<script src="{{ url_for('static', filename='lib/mediaelement-plugins/dist/markers/markers.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/mediaelement-plugins/dist/speed/speed.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='lib/mediaelement-plugins/dist/speed/speed.min.css') }}" />
<script src="{{ url_for('static', filename='lib/mediaelement-plugins/dist/jump-forward/jump-forward.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='lib/mediaelement-plugins/dist/jump-forward/jump-forward.min.css') }}" />
<script src="{{ url_for('static', filename='lib/mediaelement-plugins/dist/skip-back/skip-back.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='lib/mediaelement-plugins/dist/skip-back/skip-back.min.css') }}" />
<!--
<script src="{{ url_for('static', filename='lib/mediaelement-plugins/dist/preview') }}"></script>
-->
<script src="{{ url_for('static', filename='lib/VideoContext/docs/dist/videocontext.js') }}"></script>
<script src="{{ url_for('static', filename='lib/VideoContext/docs/js/utils.js') }}"></script>
<script src="{{ url_for('static', filename='lib/vue/dist/vue.js') }}"></script>
<script src="{{ url_for('static', filename='lib/vue-shortkey/dist/index.js') }}"></script>
<!--<script src="{{ url_for('static', filename='js/event_cut.js') }}"></script> -->
<style>
</style>
{{ super() }}
<div class="container" id="cutter-container">
    <div class="row" >
        <div class="col-sm-10">
            <p class="lead">{{ event }}</p>
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active">
                    <a href="#edit" aria-controls="edit" role="tab" data-toggle="tab">
                        <span class="glyphicon glyphicon-film" aria-hidden="true"> Cut
                    </a>
                </li>
                <li role="presentation">
                    <a href="#preview" aria-controls="preview" role="tab" data-toggle="tab">
                        <span class="glyphicon glyphicon-play" aria-hidden="true"> Preview / 
                        <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"> Save
                    </a>
                </li>
                <li role="presentation">
                    <a href="#debug" aria-controls="debug" role="tab" data-toggle="tab">
                        <span class="glyphicon glyphicon-console" aria-hidden="true"> Debug
                    </a>
                </li>
            </ul>
        </div>
{% raw %}
    <div class="tab-content">
        <div role="tabpanel"  id="edit" class="col-sm-8 tab-pane active">
            <video  style="max-width: 100%;" controls="controls" width="640" height="360" id='mediaplayer' controls="controls" preload="none" ></video>
            <p>
                <div class="progress" style="border-radius: 2px">
                    <div v-if="active_segment" class="progress-bar progress-bar-warning" role="progressbar" v-bind:style="{ width: 100*(active_segment.start/active_segment.videofile.length) + '%' }">{{ active_segment.start.toFixed(2)  }}s</div>
                    <div v-if="active_segment" class="progress-bar progress-bar-success" role="progressbar" v-bind:style="{ width: 100*(active_segment.length/active_segment.videofile.length) + '%' }">{{ active_segment.length.toFixed(2)  }}s</div>
                    <div v-if="active_segment" class="progress-bar progress-bar-warning" role="progressbar" v-bind:style="{ width: 100*((active_segment.videofile.length-active_segment.start-active_segment.length)/active_segment.videofile.length) + '%' }"></div>
                </div>
            </p>
            <p>
                <div class="panel panel-warning">
                    <div class="panel-heading">
                        <div class="panel-title"><b>set current position as:</b>
                            <button type="button" class="btn btn-success" @click="setSegmentStart"><span class="glyphicon glyphicon-play" aria-hidden="true"> Start (i)</button>
                            <button type="button" class="btn btn-success" @click="setSegmentStop"><span class="glyphicon glyphicon-stop" aria-hidden="true"> End (o)</button>
                        </div>
                    </div>
                    <div class="panel-heading">
                        <div class="panel-title"><b>Modify timeline:</b>
                            <button type="button" class="btn btn-danger"  class="btn btn-success" @click="splitSegment"><span class="glyphicon glyphicon-pause" aria-hidden="true"> Split</button>
                            <button type="button" class="btn btn-danger"  class="btn btn-success" @click="postData"><span class="glyphicon glyphicon-pause" aria-hidden="true"> Save</button>
                        </div>
                    </div>
                </div>
            </p>
        </div>
        <div role="tabpanel"  id="preview" class="col-sm-8 tab-pane">
            <canvas id="video-canvas" style="background-color: #f5f5f5; width: 100%"></canvas>
                <canvas id="visualisation-canvas" height="20" style="background-color: #f5f5f5; width: 100%"></canvas>
            <p>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-default" id="play-button"><span class="glyphicon glyphicon-play" aria-hidden="true"> Play</button>
                    <button type="button" class="btn btn-default" id="pause-button"><span class="glyphicon glyphicon-pause" aria-hidden="true"> Pause</button>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-default" id="play-button"><span class="glyphicon glyphicon-play" aria-hidden="true"> Prev</button>
                    <button type="button" class="btn btn-default" id="pause-button"><span class="glyphicon glyphicon-pause" aria-hidden="true"> Next</button>
                </div>
            </p>
<!--            <div class="progress">
                <div class="progress-bar" role="progressbar" aria-valuenow="70"
                aria-valuemin="0" aria-valuemax="100" style="width:70%">
                    <span class="sr-only">70% Complete</span>
                </div>
            </div>-->
        </div>

        <div role="tabpanel"  id="debug" class="col-sm-8 tab-pane">
{% endraw %}
<pre>
database segments:
{% for s in event.segments %}
{{ s.videofile.id }} {{ s.videofile.url }} {{ s.videofile.length }} - {{ s.segment_id }} {{ s.start }} {{ s.length }}{% endfor %}
</pre>
{% raw %}
        </div>

        <div class="col-sm-4" style="background-color: white;">
            <p class="lead">Segments</p>
            <table class="table table-hover table-striped small">
                <tbody>
                    <thead>
                    <tr>
                        <th></th>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Start</th>
                        <th>Length</th>
                        <th>File Length</th>
                    </tr>
                    </thead>
                    <tr  v-for="item in segments"  v-bind:class="{ danger: item.active }" :key="item.segment_id">
                        <td>
                            <a v-if="item.videofile.type == 'footage'" v-on:click="active_segment = item"><span class="glyphicon glyphicon-resize-horizontal" aria-hidden="true"></span></a>
                        </td>
                        <td>{{ item.segment_id }}</td>
                        <td>{{ item.videofile.type }}</td>
                        <td>{{ item.start }}</td>
                        <td>{{ item.length }}</td>
                        <td>{{ item.videofile.length }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

<!--
            <a v-for="item in items" class="list-group-item" v-bind:class="{ active: item.active }">
                <h4 class="list-group-item-heading">{{ item.message }}</h4>
                <p class="list-group-item-text">...</p>
-->
        </div>
{% endraw %}
    </div>
</div>

<script>

$(window).ready(function(){
   $('#video-canvas').height($('#video-canvas').width() * .562);
});
$(window).resize(function(){
   $('#video-canvas').height($('#video-canvas').width() * .562);
});


$(document).keydown(function(e) {
    console.log(e, e.which);
    switch(e.which) {
        case 73: // i
            cutter.setSegmentStart()
            break;
        case 79: // o
            cutter.setSegmentStop()
            break;
        case 80: // p
            break;
        case 83: // s
            cutter.splitSegment()
            break;
        case 32: // space
            if(player.paused == false)
                player.pause();
            else
                player.play();
            e.preventDefault();
            break;
        case 37: // left
            player.setCurrentTime(player.media.currentTime-0.04);
            e.preventDefault();
        case 39: // right
            player.setCurrentTime(player.media.currentTime+0.04);
            e.preventDefault();
        case 33: // page up
            player.setCurrentTime(player.media.currentTime-1.00);
            e.preventDefault();
        case 34: // page down
            player.setCurrentTime(player.media.currentTime+1.00);
            e.preventDefault();
            break;
    }
});

var cutter;
var player;

cutter = new Vue({
    el: '#cutter-container',
    data: {
        version: null,
        active_segment: null,
        segments: null,
        comment: null,
    },
    watch: {
        segments: function (newval, oldval) {
            if(oldval == null) {
                for (var i = 0, total = newval.length; i < total; ++i) {
                    if (newval[i].videofile.type == 'footage') {
                        cutter.active_segment = newval[i];
                        break;
                    }
                }
            }
        },
        active_segment: function (newval, oldval) {
            if(newval != null) {
                this.mediaplayerUpdate(newval, oldval==null);
            }
        },
    },
    methods: {
        postData: function() {
            $.ajax({
                type: "POST",
                url: "{{ get_url('.rest_segments') }}?id={{ event.id }}",
                data: JSON.stringify(this.segments),
                contentType:"application/json; charset=utf-8",
                dataType:"json",
                success: function(data) {
                    window.location = "{{ get_url('.index_view') }}"
                },
            });
        },
        setSegmentStart: function(event) {
            if(this.active_segment) {
                var end = this.active_segment.start + this.active_segment.length;
                if (player.media.currentTime < end) {
                    this.active_segment.start = player.media.currentTime;
                    this.active_segment.length = end - this.active_segment.start;
                    this.mediaplayerUpdate(this.active_segment);
                }
            }
        },
        setSegmentStop: function(event) {
            if(this.active_segment && player.media.currentTime > this.active_segment.start) {
                this.active_segment.length = player.media.currentTime - this.active_segment.start;
                this.mediaplayerUpdate(this.active_segment);
            }
        },
        splitSegment: function(event) {
            if(!this.active_segment || player.media.currentTime < this.active_segment.start ||
                player.media.currentTime > (this.active_segment.start + this.active_segment.length))
                    return;
            var i; var newsegment = Object.create(null);
            newsegment.videofile = this.active_segment.videofile;
            newsegment.videofile_id = this.active_segment.videofile_id;
            newsegment.transition = this.active_segment.transition;
            newsegment.start = player.media.currentTime;
            newsegment.length = this.active_segment.start + this.active_segment.length - player.media.currentTime;
            this.active_segment.length = player.media.currentTime - this.active_segment.start;

            for (i = 0, total = this.segments.length; i < total; ++i) {
                if (this.segments[i] == this.active_segment)
                    break;
            }
            this.segments.splice( i+1, 0, newsegment );
            for (i = 0, total = this.segments.length; i < total; ++i) {
                this.segments[i].segment_id = i;
            }
            this.active_segment = newsegment;
        },
        mediaplayerUpdate: function(segment, updatesrc = false) {
            player.options.markers = [segment.start, (segment.start + segment.length)];
            player.setmarkers(player.controls);
            if (updatesrc) {
                player.setSrc(segment.videofile.proxy_url);
                player.setCurrentTime(segment.start);
                player.load();
            }
        }
    }
})

$('#mediaplayer').mediaelementplayer({
    pluginPath: "{{ url_for('static', filename='lib/mediaelement-plugins/dist/') }}",
    features: ['playpause', 'current', 'progress', 'duration', 'skipback', 'jumpforward', 'tracks', 'speed', 'volume', 'markers'],
    alwaysShowControls: true,
    markerColor: '#E00000',
    markers: [0, 0],
    markerWidth: 2,
    speeds: ['10.0', '5.00', '2.50', '1.00', '0.50'],
    autoplay: false,
    controls: true,
    success: function(mediaElement, originalNode, instance) {
        player = instance;
    },
    markerCallback: function(media, time) {
        player.pause();
    }
});


$.getJSON( "{{ get_url('.rest_segments') }}?id={{ event.id }}", function( data ) {
    cutter.active_segment = null;
    cutter.segments = data.segments;
    cutter.comment = data.comment;
    cutter.version = data.version;
});

//console.log(cutter, player);

</script>
{% endblock body %}
